% !TEX encoding = UTF-8 Unicode

\documentclass{article}
\usepackage[french]{babel}
\author{Louis DESVERNOIS}
\title{Procédure d'installation et de déploiement pour la SAÉ23.}
% \date{9 Juin 2022}
\usepackage[margin=1in]{geometry}
\usepackage{subcaption}
\usepackage{listings}
\usepackage{minted}
\usepackage[colorlinks=true,linkcolor=black,anchorcolor=black,citecolor=black,filecolor=black,menucolor=black,runcolor=black,urlcolor=black]{hyperref}
%\setcounter{tocdepth}{1} % Show sections
%\setcounter{tocdepth}{2} % + sections
%\setcounter{tocdepth}{3} % + subsections
%\setcounter{tocdepth}{4} % + paragraphs
%\setcounter{tocdepth}{5} % + subparagraphs
%\renewcommand{\contentsname}{Tables des matières} % Change le nom de la ToC
%\renewcommand{\listfigurename}{Liste des figures}

\renewcommand{\listoflistingscaption}{Table des codes}
\renewcommand{\listingscaption}{Code}
% \renewcommand{\bibname}{Bibliographie} % Change le nom des références (bibname pour les classes book et report)

\begin{document}

\maketitle
\tableofcontents
\listoffigures
\listoflistings
\newpage
\section{Machine virtuelle et base de données}
    Notre solution se base sur une machine virtuelle utilisant la dernière version de Debian 11. La technologie utilisée pour créer cette machine virtuelle n'a peu d'importance, tant que celle-ci est accessible (eg: carte réseau en mode bridge). 

        \subsection{Installations des dépendances}
        Après l'installation d'un système minimal Debian 11, nous avons besoin d'installer les différents composant nécessaire au déploiement d'un serveur MariaDB ainsi qu'un serveur HTTP nginx.
        \begin{listing}[H]
            \begin{minted}[breaklines]{bash}
apt install git mariadb-server nginx python3 python3-pip python3-venv python3-dev libmariadb-dev ufw -y
            \end{minted}
            \caption{Installation des dépendance}
            \label{code:deps-install}
        \end{listing}

        \subsection{Configuration initiale de la base de données}
        En installant le paquet \verb|mariadb-server|, le gestionnaire de paquets apt a déjà automatique activé le service. Il nous reste donc qu'a configurer le serveur.
        \begin{listing}[H]
            \begin{minted}[breaklines]{sql}
mysql -sfu root <<EOS
UPDATE mysql.user SET Password=PASSWORD('toto') WHERE User='root';
DELETE FROM mysql.user WHERE User='';
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
CREATE USER 'toto'@'localhost';
EOS
            \end{minted}
            \caption{Configuration initiale du serveur MariaDB}
            \label{code:initdbconf}
        \end{listing}
        Pour la configuration nous utilisons la commande \verb|mysql -sfu root| pour nous connecter à la base de données et ignorer les erreurs (Code \ref{code:initdbconf}). Pour commencer, nous changeons le mot de passe de l'utilisateur "root", nous supprimons tous les utilisateurs anonymes, nous supprimons la base de données "test" si elle existe, puis nous créons l'utilisateur "toto", qui permettera à Django d'accéder à la base de données.

        \subsection{Création de l'utilisateur, clonage du dépot GitHub et execution du script SQL}
        Pour des raisons de sécurité, est préférable de ne pas éxécuter le code python de notre site avec le super-utilisateur, c'est pour cela que nous créons un utilisateur ainsi que son dossier personnel sur notre serveur. 
        \begin{listing}[H]
            \begin{minted}[breaklines]{bash}
useradd -m toto
su - toto -c "git clone https://github.com/ldsvrn/SAE23-TraficAerien /home/toto/django"
            \end{minted}
            \caption{Création de l'utilisateur et clonage du dépôt GitHub}
            \label{code:newutil}
        \end{listing}
        Après la création de l'utilisateur avec la commande \verb|useradd -m|, nous pouvons cloner le dépôt avec la commande \verb|git clone <url> <dst>|
        \footnote{\label{note1}"su - toto -c" est utilisé dans le code \ref{code:newutil} pour exécuter la commande avec l'utilisateur toto}.

        \begin{listing}[H]
            \begin{minted}[breaklines]{bash}
mysql -u root -p'toto' < /home/toto/django/SAE_23_BDD.sql
mysql -sfu root -p'toto'<<EOS
-- permission d'acces à la base de donnée
GRANT ALL PRIVILEGES ON sae_23.* TO 'toto'@'localhost';
EOS
            \end{minted}
            \caption{Importation de notre script SQL}
            \label{code:execsql}
        \end{listing}
        Ensuite, nous pouvons utiliser les commandes ci-dessus (\ref{code:execsql}) pour importer notre script SQL préalablement téléchargé lors du \verb|git clone| éxécuté précédemment (Code \ref{code:newutil}). Nous octroyons ensuite à l'utilisateur "toto" tous les droits sur la base de données importée.

\section{Environnement virtuel Python}
    Pour faire fonctionner Django, nous allons avoir besoin d'un environnement virtuel (venv) pour installer Django et ses dépendances sans les installer pour tout le système. Travailler avec des venv permet de garantir que paquets installés soient toujours les mêmes. 

        \subsection{Création de l'environnement et installation des paquets}
        Le module \verb|venv| de Python nous permet de créer ces environnements facilement avec la commande \verb|python -m venv .venv|. En supposant que l'on utilise le shell bash, nous pouvons ensuite activer cet environnement grâce à la commande \verb|source|.
        Une fois l'environnement virtuel activé, nous pouvons simplement utiliser \verb|pip3| pour intaller les dépendances de notre projet \footnote{\label{note2}Il est églament possible d'utiliser le fichier requirements.txt avec la commande "pip3 install -r requirements.txt"}. 
        Nous pouvons donc éxécuter les commandes suivantes, cette fois ci avec l'utilisateur créé précédemment (Code \ref{code:newutil}). 
        \begin{listing}[H]
            \begin{minted}{bash}
python -m venv .venv
source .venv/bin/activate
pip3 install django django-admin mysqlclient gunicorn crispy-bootstrap5 Pillow reportlab
            \end{minted}
            \caption{Création du venv et installation des paquets}
            \label{code:creation-venv}
        \end{listing}
        
        \subsection{Configuration du projet Django (settings.py)}
        Une fois toutes dépendances python intallées dans l'environnement virtuel, nous devons modifier les paramètres de notre projet Django afin d'utiliser la base de données externe. Il est intéressant de vérifier si le répertoire des fichiers statiques (eg: images, css, etc) est correctement configuré
        \footnote{\label{note3}Normalement cela est déjà configuré automatiquement à la création du projet}. 
        \begin{listing}[H]
            \begin{minted}{python}
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'sae_23',
        'USER': 'toto',
        'PASSWORD': '',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}
            \end{minted}
            \caption{settings.py: Paramétrages de la base de données}
            \label{code:settings.py-db}
        \end{listing}
        
\end{document}